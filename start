#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"
export PLAYWRIGHT_BROWSERS_PATH="$ROOT_DIR/.playwright-browsers"

if [[ -t 1 && -z "${NO_COLOR:-}" ]]; then
  C_RESET=$'\033[0m'
  C_CYAN=$'\033[36m'
  C_GREEN=$'\033[32m'
  C_YELLOW=$'\033[33m'
  C_RED=$'\033[31m'
  C_BOLD=$'\033[1m'
else
  C_RESET=""
  C_CYAN=""
  C_GREEN=""
  C_YELLOW=""
  C_RED=""
  C_BOLD=""
fi

step() { echo "${C_CYAN}->${C_RESET} $*"; }
ok() { echo "${C_GREEN}OK${C_RESET} $*"; }
warn() { echo "${C_YELLOW}WARN${C_RESET} $*"; }
err() { echo "${C_RED}ERREUR${C_RESET} $*" >&2; }

print_usage() {
  echo "Usage: ./start.sh <x_url|input.txt|liste> [autres_urls_ou_fichiers...] [--out-dir output] [--output fichier.pdf]"
  echo "Exemple 1: ./start.sh \"https://x.com/TheVixhal/status/2026002315371745671\""
  echo "Exemple 2: ./start.sh \"https://x.com/a/status/1\" \"https://x.com/b/status/2\""
  echo "Exemple 3: ./start.sh ./links.txt"
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  print_usage
  exit 0
fi

if ! command -v node >/dev/null 2>&1; then
  err "Node.js est requis."
  exit 1
fi

if ! command -v npm >/dev/null 2>&1; then
  err "npm est requis."
  exit 1
fi

if [[ ! -f package.json ]]; then
  err "package.json introuvable dans $ROOT_DIR"
  exit 1
fi

if [[ $# -eq 0 ]]; then
  warn "Aucun lien fourni."
  echo
  read -r -p "Colle un ou plusieurs liens X (ou un fichier .txt): " USER_INPUT
  if [[ -z "${USER_INPUT// }" ]]; then
    err "Aucune entree fournie."
    print_usage
    exit 1
  fi
  set -- "$USER_INPUT"
fi

if [[ ! -d node_modules || ! -d node_modules/playwright ]]; then
  step "Installation des dependances npm"
  npm install
fi

if ! node --input-type=module -e "import { chromium } from 'playwright'; import { existsSync } from 'node:fs'; process.exit(existsSync(chromium.executablePath()) ? 0 : 1);" >/dev/null 2>&1; then
  step "Installation de Chromium (Playwright)"
  npx playwright install chromium
fi

echo
echo "${C_BOLD}X Thread to PDF${C_RESET}"
step "Lancement de la conversion"
node ./src/x-thread-to-pdf.mjs "$@"
ok "Termine."
